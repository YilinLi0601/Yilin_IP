---
title: "DataCleaning1"
output: html_document
date: "2025-12-03"
---
## Basic setups
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
library(dplyr)
library(tidyverse)
library(foreign)
library(lavaan)
library(lme4)
library("dagitty")
library("semPower")
library("semPlot")
```

## Reading file
```{r}
EMA_excluded <- read_csv("DEETs_2_EMA_excluded.csv")
```
## Select variables
```{r}
EMA_select <- EMA_excluded %>%
  select(Survey.Submitted.Time, Survey.Submitted.Date, current_affect, thought_time, thought_time_text, passiveideation1, passiveideation2, sui_imagery, wish_to_die, activeideation2, stressor, stressor_time, stressor_impact, posevent, posevent_time, posevent_impact, ID, Group)
glimpse(EMA_select)
```
## Filtering ppts who endorsed SI throughout EMA
```{r}
#Marking ppts who ever endorsed SI
EMA_SI <- EMA_select %>%
  mutate(
    SI_endorse = 
      (passiveideation1 > 1) |
      (passiveideation2 > 1) |
      (wish_to_die > 1) |
      (activeideation2 > 1) |
      (sui_imagery %in% c("Yes"))
  )
#Breakdown & descriptives of participants who endorsed SI
ID_SI <- EMA_SI %>%
  group_by(ID) %>%
  summarise(
    any_SI = any(SI_endorse, na.rm = TRUE),
    N_SI = sum(SI_endorse, na.rm = TRUE),
    SI_proportion = mean(SI_endorse, na.rm = TRUE),
    N_promt = n()
  )
#ID of ppts who endorsed SI
SI_ppt <- ID_SI %>%
  filter(any_SI) %>%
  pull(ID)
#Filtering out ppts who didn't endorse SI during EMA
EMA_SIonly <- EMA_SI %>%
  filter(ID %in% SI_ppt)
#Counting final sample size
N <- EMA_SIonly %>%
  summarise(n = n_distinct(ID)) %>%
  pull(n)
#Breakdown of group membership
Membership <- EMA_SIonly %>%
  group_by(Group) %>%
  summarise(n = n_distinct(ID)) %>%
  pull(n)

```

## Dichotomising SI items for analysis.
```{r}
# Mutating passive, active and SMI into new variables for model.
EMA_SIonly <- EMA_SIonly %>%
  mutate(
    passiveSI = case_when(
      passiveideation1 > 1 | passiveideation2 > 1 ~ 1L,
      passiveideation1 == 1 & passiveideation2 == 1 ~ 0L
    ),
    activeSI = case_when(
      activeideation2 > 1 | wish_to_die > 1 ~ 1L,
      activeideation2 == 1 & wish_to_die == 1 ~ 0L
    ),
    SMI = case_when(
      sui_imagery %in% c("Yes") ~ 1L,
      sui_imagery %in% c("No") ~ 0L
    ),
    SI_any = case_when(
      SI_endorse == TRUE ~ 1L,
      SI_endorse == FALSE ~ 0L
    )
  )
```

## Coding events into new variables for analysis.
```{r}
# Coding the events, first into occurence (1=yes, 0=no), then into impact (0=no, 1=low impact, 2=high impact).
EMA_SIonly <- EMA_SIonly %>%
  mutate(
    stress_any = case_when(
      stressor == "no stressful event" ~ 0L,
      !is.na(stressor) ~ 1L
    ),
    stress_int = case_when(
      stressor == "no stressful event" ~ 0L,
      !is.na(stressor_impact) & stressor_impact <= 4 ~ 1L,
      !is.na(stressor_impact) & stressor_impact > 4 ~ 2L
    )
  ) %>%
  mutate(
    pos_any = case_when(
      posevent == "no positive event" ~ 0L,
      !is.na(posevent) ~ 1L
    ),
    pos_int = case_when(
      posevent == "no positive event" ~ 0L,
      !is.na(posevent_impact) & posevent_impact <= 4 ~ 1L,
      !is.na(posevent_impact) & posevent_impact > 4 ~ 2L
    )
  )
```

